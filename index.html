<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Grammar Galaxy: 360° Explorer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            touch-action: none;
        }

        canvas {
            display: block;
        }

        #instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #0ff;
            pointer-events: none;
            font-size: 14px;
            backdrop-filter: blur(5px);
            z-index: 5;
            line-height: 1.5;
        }

        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 22px;
            height: 22px;
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
        }

        #crosshair::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: #0ff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Landing HUD */
        #land-hud {
            position: fixed;
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 20;
        }

        #land-btn {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            color: #000;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #land-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 50px #0ff;
        }

        /* Mobile HUD */
        #mobile-hud {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        @media (pointer: coarse) {
            #mobile-hud {
                display: flex;
            }

            #instructions {
                display: none;
            }

            #crosshair {
                display: none;
            }

            #land-btn {
                padding: 20px 50px;
                font-size: 1.5em;
            }
        }

        .hud-btn {
            width: 70px;
            height: 70px;
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid #0ff;
            border-radius: 50%;
            color: #0ff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
            user-select: none;
        }

        .joystick-container {
            position: fixed;
            bottom: 40px;
            width: 130px;
            height: 130px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 1px solid rgba(0, 255, 255, 0.3);
            display: none;
            z-index: 10;
            touch-action: none;
        }

        @media (pointer: coarse) {
            .joystick-container {
                display: block;
            }
        }

        #joystick-left {
            left: 40px;
        }

        .joystick-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            background: rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            box-shadow: 0 0 20px #0ff;
        }

        /* Vein Mind Map UI Overlay */
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 10, 25, 0.95) 0%, rgba(0, 0, 0, 1) 100%);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .mind-map-container {
            position: relative;
            width: 95vw;
            height: 95vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #vein-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .node {
            position: absolute;
            width: 110px;
            height: 110px;
            background: rgba(0, 40, 80, 0.5);
            border: 2px solid #0ff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.3);
            font-weight: bold;
            color: #0ff;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85em;
        }

        .node:hover {
            transform: scale(1.15);
            box-shadow: 0 0 45px #0ff;
            background: rgba(0, 100, 150, 0.6);
        }

        .node.active {
            background: #00ffff;
            color: #000;
            box-shadow: 0 0 60px #0ff;
        }

        #central-node {
            width: 150px;
            height: 150px;
            font-size: 1.1em;
            border-width: 4px;
        }

        #explanation-node {
            top: 15%;
            left: 15%;
        }

        #vocabulary-node {
            bottom: 15%;
            left: 15%;
        }

        #practice-node {
            top: 50%;
            right: 10%;
            transform: translateY(-50%);
            width: 130px;
            height: 130px;
        }

        .content-panel {
            position: absolute;
            background: rgba(0, 20, 40, 0.9);
            backdrop-filter: blur(30px);
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 25px;
            padding: 30px;
            width: 480px;
            display: none;
            box-shadow: 0 0 60px rgba(0, 0, 0, 1);
            overflow-y: auto;
            z-index: 105;
            max-height: 80vh;
        }

        .content-panel.active {
            display: block;
            animation: panelIn 0.5s ease forwards;
        }

        #explanation-content {
            top: 10%;
            left: 55%;
        }

        #vocabulary-content {
            bottom: 12%;
            left: 35%;
        }

        #practice-content {
            top: 50%;
            right: 5%;
            transform: translateY(-50%);
        }

        .option-btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #0ff;
            color: #fff;
            border-radius: 15px;
            cursor: pointer;
            text-align: left;
            font-size: 1.1em;
            transition: 0.3s;
        }

        .option-btn:hover {
            background: rgba(0, 255, 255, 0.25);
            transform: translateX(10px);
        }

        #close-ui {
            position: absolute;
            top: 30px;
            right: 30px;
            font-size: 3em;
            cursor: pointer;
            color: #ff4136;
            z-index: 120;
            text-shadow: 0 0 15px rgba(255, 65, 54, 0.8);
            transition: 0.3s;
        }

        #close-ui:hover {
            transform: rotate(90deg) scale(1.2);
        }

        .ar-text {
            direction: rtl;
            font-family: 'Arial', sans-serif;
            font-size: 1.3em;
            color: #a29bfe;
            margin-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 10px;
        }

        .vocab-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            margin: 8px 0;
            border-radius: 15px;
            border-left: 5px solid #0ff;
        }

        /* Feedback Bubble */
        #feedback-bubble {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(238, 82, 83, 0.95);
            color: white;
            padding: 25px;
            border-radius: 20px;
            border: 3px solid #fff;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8);
            max-width: 400px;
            display: none;
            text-align: center;
            z-index: 200;
            backdrop-filter: blur(10px);
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes bounceIn {
            from {
                opacity: 0;
                transform: translateX(-50%) scale(0.5);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
        }
    </style>
</head>

<body>
    <div id="instructions">
        <strong>Grammar Galaxy (360° Explorer)</strong><br>
        WASD: Move | MWScroll: Zoom In/Out<br>
        Approach & click <b>LAND ON PLANET</b><br>
        <span style="color: #0ff;">360° Freedom: Look & fly in any direction.</span>
    </div>

    <div id="crosshair"></div>

    <div id="land-hud">
        <div id="land-btn">Land on Planet</div>
    </div>

    <div id="joystick-left" class="joystick-container">
        <div class="joystick-knob"></div>
    </div>
    <div id="mobile-hud">
        <div id="btn-up" class="hud-btn">▲</div>
        <div id="btn-down" class="hud-btn">▼</div>
    </div>

    <div id="ui-overlay">
        <span id="close-ui">&times;</span>
        <div class="mind-map-container">
            <svg id="vein-svg">
                <path id="path-exp" d="" stroke="#0ff" stroke-width="4" fill="none" opacity="0.6" />
                <path id="path-voc" d="" stroke="#0ff" stroke-width="4" fill="none" opacity="0.6" />
                <path id="path-pra" d="" stroke="#0ff" stroke-width="4" fill="none" opacity="0.6" />
            </svg>
            <div id="central-node" class="node">Topic</div>
            <div id="explanation-node" class="node" onclick="togglePanel('explanation')">Lesson</div>
            <div id="vocabulary-node" class="node" onclick="togglePanel('vocabulary')">Vocab</div>
            <div id="practice-node" class="node" onclick="togglePanel('practice')">Quiz</div>

            <div id="explanation-content" class="content-panel"></div>
            <div id="vocabulary-content" class="content-panel"></div>
            <div id="practice-content" class="content-panel"></div>
        </div>
    </div>

    <div id="feedback-bubble"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script>
        const SYLLABUS = {
            "planets": [
                {
                    "id": 1, "name": "Food Planet", "topic": "Food Categories & Ordering", "color": "#FF4136",
                    "richExplanation": {
                        "en": "Countable nouns (apples) have plural forms. Uncountable nouns (water, rice) don't. Use 'a glass of' for liquids.",
                        "ar": "الأسماء المعدودة لها صيغة جمع. غير المعدودة (ماء، أرز) ليس لها جمع. نستخدم 'a glass of' للسوائل."
                    },
                    "vocabulary": [{ "en": "Apple pie", "ar": "فطيرة تفاح" }, { "en": "Steak", "ar": "شريحة لحم" }, { "en": "Soft drinks", "ar": "مشروبات غازية" }],
                    "practice": [
                        { "q": "It's a type of desserts:", "options": ["Salad", "Soup", "Pasta", "Apple pie"], "answer": 3, "feedback": { "en": "Salad is a vegetable dish. Apple pie is sweet, so it is a dessert.", "ar": "خيار خاطئ. السلطة طبق خضار. فطيرة التفاح حلوة، لذا هي من الحلويات." } },
                        { "q": "I'd like a glass ___ water.", "options": ["from", "on", "in", "of"], "answer": 3, "feedback": { "en": "We say 'a glass OF water' to show content.", "ar": "خيار خاطئ. نقول 'glass of water' لتحديد المحتوى." } }
                    ]
                },
                {
                    "id": 2, "name": "Routine Planet", "topic": "Present Simple & Adverbs", "color": "#2ECC40",
                    "richExplanation": {
                        "en": "Adverbs like Always/Usually go BEFORE main verb (He usually walks) but AFTER Verb 'To Be' (He is always late).",
                        "ar": "ظروف التكرار (Always/Usually) تأتي قبل الفعل الأساسي وبعد فعل 'To Be'."
                    },
                    "vocabulary": [{ "en": "Usually", "ar": "عادة" }, { "en": "Often", "ar": "غالبا" }, { "en": "Once a week", "ar": "مرة في الأسبوع" }],
                    "practice": [
                        { "q": "Teachers ___ usually use webcams.", "options": ["Teachers", "Nurses", "Farmers", "businessmen"], "answer": 0, "feedback": { "en": "Teachers work in classrooms with webcams. Nurses work in hospitals.", "ar": "خيار خاطئ. المعلمون يستخدمون الكاميرات في الفصول، الممرضات يعملن في المستشفيات." } },
                        { "q": "I work out ___ a week.", "options": ["one", "once", "two", "three"], "answer": 1, "feedback": { "en": "'One' is a number. 'Once' means 'one time'.", "ar": "خيار خاطئ. 'One' هو رقم. 'Once' تعني مرة واحدة." } }
                    ]
                },
                {
                    "id": 3, "name": "Action Planet", "topic": "Present Continuous", "color": "#0074D9",
                    "richExplanation": {
                        "en": "Ongoing actions: [Am/Is/Are] + [Verb-ing]. Drop 'e' for verbs like 'make' -> 'making'.",
                        "ar": "الأفعال المستمرة: [Am/Is/Are] + [الفعل-ing]. نحذف 'e' في أفعال مثل 'make'."
                    },
                    "vocabulary": [{ "en": "Making soup", "ar": "يصنع حساء" }, { "en": "Running away", "ar": "يهرب" }, { "en": "Hanging out", "ar": "يتسكع" }],
                    "practice": [
                        { "q": "My sister is ___ a soup.", "options": ["breaking", "writing", "talking", "making"], "answer": 3, "feedback": { "en": "You 'make' food; you don't 'break' or 'write' it.", "ar": "خيار خاطئ. أنت 'تعد' الطعام؛ لا يمكنك كتابته أو كسره." } },
                        { "q": "The thieves are running ___.", "options": ["away", "close", "on", "come"], "answer": 0, "feedback": { "en": "The phrasal verb 'run away' means to escape.", "ar": "خيار خاطئ. الفعل المركب 'run away' يعني يهرب." } }
                    ]
                },
                {
                    "id": 4, "name": "Quantity Planet", "topic": "Quantifiers (Much/Many)", "color": "#DDDDDD",
                    "richExplanation": {
                        "en": "'Too' implies excessive. 'Much' = Uncountable. 'Many' = Countable. 'Some' = Positive.",
                        "ar": "'Too' تعني زيادة مفرطة. 'Much' لغير المعدود. 'Many' للمعدود. 'Some' للجمل المثبتة."
                    },
                    "vocabulary": [{ "en": "Too much", "ar": "كثير جدا" }, { "en": "Salty", "ar": "مالح" }, { "en": "Juice", "ar": "عصير" }],
                    "practice": [
                        { "q": "The soup is ___ salty.", "options": ["too", "many", "much", "to"], "answer": 0, "feedback": { "en": "'Many' is for nouns we count. 'Too' is for adjectives like 'salty'.", "ar": "خيار خاطئ. 'Many' للمعدود. 'Too' للصفات مثل مالح." } },
                        { "q": "There is ___ juice.", "options": ["some", "any", "are", "of"], "answer": 0, "feedback": { "en": "We use 'some' in positive sentences.", "ar": "خيار خاطئ. نستخدم 'some' في الجمل المثبتة." } }
                    ]
                },
                {
                    "id": 5, "name": "Ambition Planet", "topic": "Gerunds vs Infinitives", "color": "#FFDC00",
                    "richExplanation": {
                        "en": "Gerunds (-ing) act as nouns. Recommend is followed by a Gerund. Want is followed by an Infinitive (to be).",
                        "ar": "Gerunds (-ing) تعمل كأسماء. 'Recommend' يتبعها Gerund، و 'Want' يتبعها Infinitive."
                    },
                    "vocabulary": [{ "en": "Recommend", "ar": "يوصي" }, { "en": "Want to be", "ar": "يريد أن يكون" }, { "en": "Know how", "ar": "يعرف كيف" }],
                    "practice": [
                        { "q": "I recommend ___ basketball.", "options": ["playing", "plays", "play", "played"], "answer": 0, "feedback": { "en": "The verb 'recommend' is always followed by -ing.", "ar": "خيار خاطئ. الفعل 'recommend' يتبعه دائماً فعل مضاف له ing." } },
                        { "q": "I want ___ an engineer.", "options": ["to be", "be", "is", "are"], "answer": 0, "feedback": { "en": "After 'want', we must use 'to' + verb.", "ar": "خيار خاطئ. بعد 'want'، يجب أن نستخدم 'to' + الفعل." } }
                    ]
                },
                {
                    "id": 6, "name": "Locator Planet", "topic": "Prepositions & Relative Pronouns", "color": "#85144b",
                    "richExplanation": {
                        "en": "'Who' = People. 'Which' = Things. 'Across from' = Relative location (opposite side).",
                        "ar": "'Who' للأشخاص. 'Which' للأشياء. 'Across from' للموقع المقابل."
                    },
                    "vocabulary": [{ "en": "Across from", "ar": "مقابل" }, { "en": "Behind", "ar": "خلف" }, { "en": "Which", "ar": "الذي (للأشياء)" }],
                    "practice": [
                        { "q": "The park is ___ the school.", "options": ["across from", "on", "between", "in"], "answer": 0, "feedback": { "en": "'On' means touching surface. Use 'across from' for the other side.", "ar": "خيار خاطئ. 'On' تعني على السطح. الحديقة في الجانب المقابل (across from)." } },
                        { "q": "A company ___ builds roads.", "options": ["which", "who", "why", "what"], "answer": 0, "feedback": { "en": "'Who' is for people. A company is a thing, so use 'which'.", "ar": "خيار خاطئ. 'Who' للناس. الشركة شيء، لذا نستخدم 'which'." } }
                    ]
                },
                {
                    "id": 7, "name": "Story Planet", "topic": "Mohammed's Story", "color": "#B10DC9",
                    "richExplanation": {
                        "en": "Reading Text: Mohammed is busy. He plays basketball and works as a cashier. He is happy because he has a vacation next week.",
                        "ar": "نص القراءة: محمد مشغول. يلعب كرة السلة ويعمل صرافاً. هو سعيد بوجود إجازة الأسبوع القادم."
                    },
                    "readingText": "Mohammed feels tired lately. He thinks he is too busy. He plays basketball for his school team. He also works three nights a week as a cashier at a grocery store. At home, he does his studies and homework. Mohammed wants more free time. He is very happy because he has a vacation next week!",
                    "vocabulary": [{ "en": "Tired", "ar": "مُتعب" }, { "en": "Busy", "ar": "مشغول" }, { "en": "Cashier", "ar": "صراف" }, { "en": "Vacation", "ar": "إجازة" }],
                    "practice": [
                        { "q": "Who does Mohammed play basketball for?", "options": ["School team", "Friends"], "answer": 0, "feedback": { "en": "The text explicitly says 'school team'.", "ar": "خيار خاطئ. النص يذكر صراحة 'فريق المدرسة'." } },
                        { "q": "How many nights does he work?", "options": ["Three", "Two"], "answer": 0, "feedback": { "en": "The text says 'three nights a week'.", "ar": "خيار خاطئ. النص يقول 'ثلاث ليالٍ في الأسبوع'." } },
                        { "q": "Why does he feel tired?", "options": ["He is too busy", "He is not busy"], "answer": 0, "feedback": { "en": "He thinks he is too busy.", "ar": "خيار خاطئ. يعتقد أنه مشغول جداً." } }
                    ]
                }
            ]
        };

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 20000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- Procedural Skybox ---
        const starGeo = new THREE.SphereGeometry(12000, 64, 64);
        const starTex = new THREE.CanvasTexture((() => {
            const c = document.createElement('canvas'); c.width = 2048; c.height = 1024; const ctx = c.getContext('2d');
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, 2048, 1024);
            for (let i = 0; i < 9000; i++) { ctx.fillStyle = `rgba(255,255,255,${Math.random()})`; ctx.beginPath(); ctx.arc(Math.random() * 2048, Math.random() * 1024, Math.random() * 1.2, 0, Math.PI * 2); ctx.fill(); }
            return c;
        })());
        scene.add(new THREE.Mesh(starGeo, new THREE.MeshBasicMaterial({ map: starTex, side: THREE.BackSide })));

        const sun = new THREE.Mesh(new THREE.SphereGeometry(80, 64, 64), new THREE.MeshStandardMaterial({ emissive: 0xff4500, emissiveIntensity: 2, color: 0xffcc00 }));
        scene.add(sun);
        const sunGlow = new THREE.PointLight(0xffffff, 6, 9000); scene.add(sunGlow);
        scene.add(new THREE.AmbientLight(0x303030));

        const planets = [];
        SYLLABUS.planets.forEach((p, i) => {
            const orbitDist = 600 + (i * 450);
            const group = new THREE.Group();
            const planetMesh = new THREE.Mesh(new THREE.SphereGeometry(45, 32, 32), new THREE.MeshStandardMaterial({ color: p.color, roughness: 0.7 }));
            planetMesh.userData = { p }; group.add(planetMesh);

            const ring = new THREE.Mesh(new THREE.TorusGeometry(80, 2, 2, 64), new THREE.MeshStandardMaterial({ color: p.color, transparent: true, opacity: 0.4 }));
            ring.rotation.x = Math.PI / 2; group.add(ring);

            const can = document.createElement('canvas'); can.width = 128; can.height = 128; const ctx = can.getContext('2d');
            ctx.fillStyle = p.color; ctx.shadowBlur = 10; ctx.shadowColor = '#000'; ctx.font = 'Bold 85px Arial'; ctx.textAlign = 'center'; ctx.fillText(p.id, 64, 90);
            const spr = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(can) }));
            spr.scale.set(70, 70, 1); spr.position.y = 90; group.add(spr);

            group.position.x = orbitDist; scene.add(group);
            planets.push({ group, angle: Math.random() * Math.PI * 2, orbit: orbitDist, speed: 0.0015 / (i + 1), data: p });
            p.currentQ = 0; // State for tracking multiple questions
        });

        // --- Interaction & Controls ---
        let keys = {}, pitch = 0, yaw = 0, isUI = false, activePlanetObj = null;
        let joyL = { x: 0, y: 0, active: false }, mElev = 0, zoom = 75;

        document.addEventListener('keydown', e => keys[e.code] = true);
        document.addEventListener('keyup', e => keys[e.code] = false);
        window.addEventListener('wheel', e => { if (isUI) return; zoom = Math.max(30, Math.min(110, zoom + e.deltaY * 0.05)); camera.fov = zoom; camera.updateProjectionMatrix(); });

        renderer.domElement.addEventListener('mousedown', () => { if (!isUI && document.pointerLockElement !== renderer.domElement) renderer.domElement.requestPointerLock(); });
        document.addEventListener('mousemove', e => { if (document.pointerLockElement === renderer.domElement) { yaw -= e.movementX * 0.002; pitch = Math.max(-1.5, Math.min(1.5, pitch - e.movementY * 0.002)); } });

        const landBtn = document.getElementById('land-btn');
        landBtn.onclick = () => { if (activePlanetObj) openUI(activePlanetObj.data); };

        function setupJoystick(id, data) {
            const el = document.getElementById(id); const knob = el.querySelector('.joystick-knob'); const center = 65;
            const handleTouch = (e) => {
                const rect = el.getBoundingClientRect(); const touch = e.touches[0];
                let dx = touch.clientX - (rect.left + center); let dy = touch.clientY - (rect.top + center);
                const dist = Math.min(65, Math.sqrt(dx * dx + dy * dy)); const ang = Math.atan2(dy, dx);
                dx = Math.cos(ang) * dist; dy = Math.sin(ang) * dist;
                knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                data.x = dx / 65; data.y = dy / 65; data.active = true;
            };
            el.addEventListener('touchstart', e => { e.preventDefault(); handleTouch(e); });
            el.addEventListener('touchmove', e => { e.preventDefault(); handleTouch(e); });
            el.addEventListener('touchend', () => { knob.style.transform = 'translate(-50%, -50%)'; data.x = 0; data.y = 0; data.active = false; });
        }
        setupJoystick('joystick-left', joyL);
        document.getElementById('btn-up').ontouchstart = () => mElev = 1; document.getElementById('btn-up').ontouchend = () => mElev = 0;
        document.getElementById('btn-down').ontouchstart = () => mElev = -1; document.getElementById('btn-down').ontouchend = () => mElev = 0;

        camera.position.set(0, 1000, 2500);

        function updateController() {
            if (isUI) return;
            camera.quaternion.setFromEuler(new THREE.Euler(pitch, yaw, 0, 'YXZ'));
            const move = new THREE.Vector3();
            if (keys['KeyW']) move.z -= 1; if (keys['KeyS']) move.z += 1;
            if (keys['KeyA']) move.x -= 1; if (keys['KeyD']) move.x += 1;
            if (keys['Space']) move.y += 1; if (keys['ShiftLeft']) move.y -= 1;
            if (joyL.active) { move.z += joyL.y; move.x += joyL.x; } move.y += mElev;
            camera.position.addScaledVector(move.applyQuaternion(camera.quaternion), 18);

            let near = null;
            planets.forEach(p => { if (camera.position.distanceTo(p.group.position) < 220) near = p; });
            activePlanetObj = near;
            document.getElementById('land-hud').style.display = near ? 'flex' : 'none';
        }

        // --- UI & Feedback Logic ---
        function showFeedback(feedback) {
            const bubble = document.getElementById('feedback-bubble');
            bubble.innerHTML = `<strong>Try Again:</strong><br>${feedback.en}<hr class="ar-text" style="border:none; border-top:1px solid rgba(255,255,255,0.2);"><div class="ar-text">${feedback.ar}</div>`;
            bubble.style.display = 'block';
            setTimeout(() => { bubble.style.display = 'none'; }, 4000);
        }

        function openUI(data) {
            isUI = true; document.exitPointerLock();
            document.getElementById('ui-overlay').style.display = 'flex';
            document.getElementById('central-node').innerText = data.name;
            togglePanel('explanation'); drawVeins();
        }
        function closeUI() {
            isUI = false;
            document.getElementById('ui-overlay').style.display = 'none';
            document.getElementById('feedback-bubble').style.display = 'none';
            zoom = 75; camera.fov = zoom; camera.updateProjectionMatrix();
            if (activePlanetObj) {
                const dir = new THREE.Vector3().subVectors(camera.position, activePlanetObj.group.position).normalize();
                camera.position.addScaledVector(dir, 200);
            }
        }
        document.getElementById('close-ui').onclick = closeUI;

        function togglePanel(type) {
            document.querySelectorAll('.content-panel, .node').forEach(el => el.classList.remove('active'));
            document.getElementById(type + '-node').classList.add('active');
            const panel = document.getElementById(type + '-content'); panel.classList.add('active');
            const p = activePlanetObj.data;

            if (type === 'explanation') {
                let html = `<h2>${p.topic}</h2>`;
                if (p.readingText) html += `<div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; margin-bottom:15px;"><i>${p.readingText}</i></div>`;
                html += `<p>${p.richExplanation.en}</p><div class="ar-text">${p.richExplanation.ar}</div>`;
                panel.innerHTML = html;
            }
            else if (type === 'vocabulary') panel.innerHTML = `<h2>Vocabulary</h2>` + p.vocabulary.map(v => `<div class="vocab-item"><strong>${v.en}</strong><br>${v.ar}</div>`).join('');
            else if (type === 'practice') {
                const q = p.practice[p.currentQ || 0];
                panel.innerHTML = `<h2>Quiz</h2><p style="font-size:1.1em;">${q.q}</p>` + q.options.map((o, i) => `<button class="option-btn" onclick="checkAnswer(${i}, ${q.answer}, ${JSON.stringify(q.feedback).replace(/"/g, '&quot;')})">${o}</button>`).join('');
            }
        }

        function checkAnswer(idx, correct, feedback) {
            if (idx === correct) {
                const p = activePlanetObj.data;
                if (p.currentQ < p.practice.length - 1) {
                    p.currentQ++;
                    togglePanel('practice');
                } else {
                    alert("Legendary! You've mastered all challenges on this planet.");
                    p.currentQ = 0;
                    closeUI();
                }
            } else {
                showFeedback(feedback);
            }
        }

        function drawVeins() {
            const root = document.getElementById('central-node').getBoundingClientRect();
            const cx = root.left + root.width / 2, cy = root.top + root.height / 2;
            ['explanation', 'vocabulary', 'practice'].forEach(id => {
                const node = document.getElementById(id + '-node').getBoundingClientRect();
                const nx = node.left + node.width / 2, ny = node.top + node.height / 2;
                document.getElementById('path-' + id.substring(0, 3)).setAttribute('d', `M ${cx} ${cy} C ${cx + (nx - cx) / 2} ${cy}, ${cx + (nx - cx) / 2} ${ny}, ${nx} ${ny}`);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            updateController();
            if (!isUI) {
                sun.rotation.y += 0.003;
                planets.forEach(p => { p.angle += p.speed; p.group.position.x = Math.cos(p.angle) * p.orbit; p.group.position.z = Math.sin(p.angle) * p.orbit; });
            }
            renderer.render(scene, camera);
        }
        window.onresize = () => { renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); if (isUI) drawVeins(); };
        animate();
    </script>
</body>

</html>
